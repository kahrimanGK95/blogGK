pipeline{ 
   
 
  agent any
	options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }
    triggers {
        pollSCM('H/15 * * * *')
    }
    tools {
        maven 'Maven 3.3.3'
        jdk 'JDK8u60'
    }
	
	stages{
		stage ('insure-claims-bom') {
			steps{
				dir('./insure-claims-bom/') {
					sh 'mvn -U clean source:jar deploy -DdeployAtEnd=true --settings ../configuration/insure_claims_maven_settings.xml -DaltDeploymentRepository=snapshots::default::https://ci-nexus.adesso.de/nexus/content/repositories/insure-claims-snapshot/'
				}
			}
		}
		stage ('insure-claims') {
			steps{
				dir('./parent/') {
					sh 'mvn -U clean source:jar deploy -DdeployAtEnd=true --settings ../configuration/insure_claims_maven_settings.xml -DaltDeploymentRepository=snapshots::default::https://ci-nexus.adesso.de/nexus/content/repositories/insure-claims-snapshot/'
				}
			}
		}
		stage ('insure-claims-domain') {
			steps{
				dir('./schnittstellen/claims-domain/claims-domain-parent/'){
					sh 'mvn -U clean deploy -DdeployAtEnd=true --settings ../../../configuration/insure_claims_maven_settings.xml -DaltDeploymentRepository=snapshots::default::https://ci-nexus.adesso.de/nexus/content/repositories/insure-claims-snapshot/'
				}
			}
		}
		stage ('insure-claims-integration') {
			steps{
				dir('./schnittstellen/claims-integration'){
					sh 'mvn -U clean deploy -DdeployAtEnd=true --settings ../../configuration/insure_claims_maven_settings.xml -DaltDeploymentRepository=snapshots::default::https://ci-nexus.adesso.de/nexus/content/repositories/insure-claims-snapshot/'
				}
			}
		}
	}
	post{
		always {
			echo 'Building job done.'
			junit '**/target/surefire-reports/*.xml'
        }
		failure{
            script{
				mail (
					from: 'Jenkins <noreply@ci-jenkins.adesso.de>',
					to: 'markus.krekeler@adesso.de,Abdelhamid.Aboumerouane@adesso-insurance-solutions.de,Dorothee.Wiethoff@adesso-insurance-solutions.de,Christian.Binkhoff@adesso-insurance-solutions.de,lenard.gaida@adesso-insurance-solutions.de',
					subject: "Pipeline-Job '${env.JOB_NAME}' (${env.BUILD_NUMBER}) is UNSTABLE!",
					body: "Please go to ${env.BUILD_URL}."
				)
            }             
        }
		success {
            script {
                if ('SUCCESS' != currentBuild.getPreviousBuild().getResult()) {
					mail (
						from: 'Jenkins <noreply@ci-jenkins.adesso.de>',
						to: 'markus.krekeler@adesso.de,Abdelhamid.Aboumerouane@adesso-insurance-solutions.de,Dorothee.Wiethoff@adesso-insurance-solutions.de,Christian.Binkhoff@adesso-insurance-solutions.de,lenard.gaida@adesso-insurance-solutions.de',
						subject: "Pipeline-Job '${env.JOB_NAME}' (${env.BUILD_NUMBER}) is STABLE again!",
						body: "Please go to ${env.BUILD_URL}."
					)
                }
            }
        }
	}
}
